name: Vercel Production Deployment

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  deploy:
    name: Deploy to Vercel Production
    runs-on: ubuntu-latest
    env:
      # These secrets must be added in GitHub repository settings
      # Settings ‚Üí Secrets and variables ‚Üí Actions
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }} # yamllint disable-line rule:context-access
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }} # yamllint disable-line rule:context-access
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }} # yamllint disable-line rule:context-access
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Check Vercel Secrets
        id: check-secrets
        run: |
          MISSING_SECRETS=()
          
          if [ -z "$VERCEL_TOKEN" ]; then
            MISSING_SECRETS+=("VERCEL_TOKEN")
          fi
          if [ -z "$VERCEL_ORG_ID" ]; then
            MISSING_SECRETS+=("VERCEL_ORG_ID")
          fi
          if [ -z "$VERCEL_PROJECT_ID" ]; then
            MISSING_SECRETS+=("VERCEL_PROJECT_ID")
          fi
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "has_secrets=false" >> $GITHUB_OUTPUT
            echo "::warning::Missing Vercel secrets: ${MISSING_SECRETS[*]}"
            echo ""
            echo "## ‚ö†Ô∏è  Deployment Skipped - Secrets Not Configured"
            echo ""
            echo "To enable automatic deployment, add the following secrets to your GitHub repository:"
            echo ""
            echo "### Quick Setup:"
            echo "1. Go to: **Settings** ‚Üí **Secrets and variables** ‚Üí **Actions**"
            echo "2. Click **New repository secret** and add each:"
            echo ""
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "   - **$secret**"
            done
            echo ""
            echo "### How to get these values:"
            echo ""
            echo "- **VERCEL_TOKEN**: Create at https://vercel.com/account/tokens"
            echo "- **VERCEL_ORG_ID**: Vercel Dashboard ‚Üí Team Settings ‚Üí General ‚Üí Team ID"
            echo "- **VERCEL_PROJECT_ID**: Vercel Dashboard ‚Üí Project ‚Üí Settings ‚Üí General ‚Üí Project ID"
            echo ""
            echo "üìñ See \`.github/workflows/QUICK_SETUP.md\` for detailed step-by-step instructions."
            echo ""
            echo "üí° **Note:** Deployment will be skipped until secrets are configured."
          else
            echo "has_secrets=true" >> $GITHUB_OUTPUT
            echo "‚úì All Vercel secrets are configured"
          fi

      - name: Pull Vercel Environment Information
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: vercel pull --yes --environment=production --token="$VERCEL_TOKEN"
        continue-on-error: true

      - name: Build Project Artifacts
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: vercel build --prod --token="$VERCEL_TOKEN"
        continue-on-error: true

      - name: Deploy Project Artifacts to Vercel
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: vercel deploy --prebuilt --prod --token="$VERCEL_TOKEN"
        continue-on-error: true

      - name: Deployment Status
        if: success() && steps.check-secrets.outputs.has_secrets == 'true'
        run: echo "‚úÖ Successfully deployed to Vercel Production"
      
      - name: Skipped Deployment Notice
        if: steps.check-secrets.outputs.has_secrets == 'false'
        run: |
          echo "‚ÑπÔ∏è  Deployment was skipped because Vercel secrets are not configured."
          echo ""
          echo "This is expected if you haven't set up Vercel deployment yet."
          echo "To enable automatic deployment, add the required secrets in GitHub repository settings."

