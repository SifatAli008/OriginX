rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function userDocExists() {
      return isAuthenticated() && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isAdmin() {
      return isAuthenticated() && userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Users collection
    match /users/{userId} {
      // Allow users to read their own document OR admins to read any
      allow get: if isAuthenticated() && (
        request.auth.uid == userId || 
        isAdmin()
      );
      
      // Allow querying users collection
      // Authenticated users can list (for email lookups, etc.)
      // Admins can list all users (for user management)
      // This allows server-side queries from authenticated admin users
      allow list: if isAuthenticated() && (
        // Allow if user is admin OR if just checking their own document
        isAdmin() || request.auth.uid == userId
      );
      
      // Allow user to create their own document (first-time login)
      // OR allow admin to create any user document if admin's user doc exists
      allow create: if isAuthenticated() && (
        // User creating their own document (most common case for new Google login)
        (request.auth.uid == userId) ||
        // Admin creating any document (only if admin's own doc exists)
        isAdmin()
      );
      
      // Allow user to update their own document OR admin to update any user
      // Note: Users can update any field in their own document, including role
      allow update: if isAuthenticated() && (
        request.auth.uid == userId || 
        isAdmin()
      );
      
      // Allow delete only for admin
      allow delete: if isAdmin();
    }

    // Organizations collection
    match /orgs/{orgId} {
      // Allow authenticated users to read all organizations (for joining existing companies)
      // This allows both get and list operations
      allow get: if isAuthenticated();
      allow list: if isAuthenticated();
      
      // Only admins can create/update/delete organizations
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Products collection
    match /products/{productId} {
      // Allow reads to authenticated users
      allow get: if isAuthenticated();
      allow list: if isAuthenticated();
      // Only company/SME users can create; enforce manufacturerId is the creator
      allow create: if isAuthenticated() && userDocExists() && (
        let r = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
        (r == 'sme' || r == 'company')
      ) && request.resource.data.manufacturerId == request.auth.uid;
      // No updates by users (immutable product meta after creation)
      allow update: if false;
      // Deletion only by admin
      allow delete: if isAdmin();
    }

    // Batches collection
    match /batches/{batchId} {
      // Allow reading batches that belong to user's organization
      allow get: if isAuthenticated() && userDocExists() && resource.data.orgId != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == resource.data.orgId;
      // Allow querying batches (results filtered by get permission)
      allow list: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && userDocExists() && resource.data.orgId != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == resource.data.orgId;
      allow delete: if isAdmin();
    }

    // Movements collection
    match /movements/{moveId} {
      // In development, allow access when authenticated OR when no auth (for test tokens)
      allow get: if isAuthenticated() || request.auth == null;
      allow list: if isAuthenticated() || request.auth == null;
      allow create: if isAuthenticated() || request.auth == null;
      allow update: if isAuthenticated() && userDocExists() && (
        let r = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
        (r == 'sme' || r == 'company' || isAdmin())
      );
      allow delete: if isAdmin();
    }

    // Handovers collection (digital handover logs)
    match /handovers/{handoverId} {
      // In development, allow access when authenticated OR when no auth (for test tokens)
      allow get: if isAuthenticated() || request.auth == null;
      allow list: if isAuthenticated() || request.auth == null;
      allow create: if isAuthenticated() || request.auth == null; // Created via API route with permission checks
      allow update: if false; // Handovers are immutable
      allow delete: if false; // Handovers cannot be deleted
    }

    // QC Logs collection (quality control logs)
    match /qc_logs/{qcLogId} {
      // In development, allow access when authenticated OR when no auth (for test tokens)
      allow get: if isAuthenticated() || request.auth == null;
      allow list: if isAuthenticated() || request.auth == null;
      allow create: if isAuthenticated() || request.auth == null; // Created via API route with permission checks (warehouse/admin only)
      allow update: if false; // QC logs are immutable
      allow delete: if false; // QC logs cannot be deleted
    }

    // Verifications collection
    match /verifications/{verificationId} {
      // In development, allow access when authenticated OR when no auth (for test tokens)
      allow get: if isAuthenticated() || request.auth == null;
      allow list: if isAuthenticated() || request.auth == null;
      // Allow authenticated users to create verifications via API (authentication verified in API route)
      allow create: if isAuthenticated() || request.auth == null;
      allow update: if false;
      allow delete: if false;
    }

    // Transactions collection (append-only ledger)
    match /transactions/{transactionId} {
      // In development, allow access when authenticated OR when no auth (for test tokens)
      allow get: if isAuthenticated() || request.auth == null;
      allow list: if isAuthenticated() || request.auth == null;
      // Allow authenticated users to create transactions via API (authentication verified in API route)
      // Transactions are immutable once created
      allow create: if isAuthenticated() || request.auth == null;
      allow update: if false; // Transactions are immutable
      allow delete: if false; // Transactions cannot be deleted
    }

    // Suppliers collection
    match /suppliers/{supplierId} {
      allow get: if isAuthenticated();
      allow list: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Reports collection
    match /reports/{reportId} {
      allow get: if isAuthenticated() && (
        isAdmin() ||
        (userDocExists() && (
          let r = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
          (r == 'sme' || r == 'company')
        )) ||
        (resource.data.reporterId != null && request.auth.uid == resource.data.reporterId)
      );
      allow list: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Alerts collection
    match /alerts/{alertId} {
      // Allow reading alerts that belong to user's organization
      allow get: if isAuthenticated() && userDocExists() && resource.data.orgId != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == resource.data.orgId;
      // Allow querying alerts (results filtered by get permission)
      allow list: if isAuthenticated();
      allow create: if false;
      allow update: if isAuthenticated() && userDocExists() && (isAdmin() || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == resource.data.orgId);
      allow delete: if isAdmin();
    }

    // Company registration requests collection
    match /companyRegistrationRequests/{requestId} {
      // Allow users to read their own requests or admins to read all
      // When reading, resource exists
      allow get: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      // Allow users to list/query their own requests or admins to query all
      allow list: if isAuthenticated();
      
      // Allow authenticated users to create requests with their own userId
      // Use request.resource because document doesn't exist yet when creating
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Only admins can update requests (to approve/reject)
      allow update: if isAdmin();
    }

    // User invitations collection
    match /userInvitations/{invitationId} {
      // Allow users to read invitations that match their email OR admin to read all
      allow get: if isAuthenticated() && (
        resource.data.email == request.auth.token.email ||
        isAdmin()
      );
      
      // Allow querying by email (for linkUserToInvitation)
      // Users can query for invitations, but can only read documents matching their email
      // The query itself is allowed, but results are filtered by get permission
      allow list: if isAuthenticated();
      
      allow create: if isAuthenticated() && (
        // Allow creating invitation with user's own email (for self-registration scenarios)
        // OR admin can create any invitation
        request.resource.data.email == request.auth.token.email ||
        isAdmin()
      );
      // Allow users to update their own invitation (when accepting it) OR admin to update any
      allow update: if isAuthenticated() && (
        resource.data.email == request.auth.token.email ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }

    // MFA secrets (server-only)
    match /mfa_secrets/{userId} {
      allow read: if false;
      allow write: if false;
    }
  }
}
