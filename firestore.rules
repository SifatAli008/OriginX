rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function userDocExists() {
      return isAuthenticated() && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Users collection
    match /users/{userId} {
      // Allow users to read their own document OR admins to read any
      allow get: if isAuthenticated() && (
        request.auth.uid == userId || 
        (userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
      
      // Allow querying users collection (for email lookups, etc.)
      // Results will still be filtered by get permissions
      allow list: if isAuthenticated();
      
      // Allow user to create their own document (first-time login)
      // OR allow admin to create any user document if admin's user doc exists
      allow create: if isAuthenticated() && (
        // User creating their own document (most common case for new Google login)
        (request.auth.uid == userId) ||
        // Admin creating any document (only if admin's own doc exists)
        (userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
      
      // Allow user to update their own document OR admin to update any user
      // Note: Users can update any field in their own document, including role
      allow update: if isAuthenticated() && (
        request.auth.uid == userId || 
        (userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
      
      // Allow delete only for admin
      allow delete: if isAuthenticated() && userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Organizations collection
    match /orgs/{orgId} {
      // Allow authenticated users to read all organizations (for joining existing companies)
      // This allows both get and list operations
      allow get: if isAuthenticated();
      allow list: if isAuthenticated();
      
      // Only admins can create/update/delete organizations
      allow create: if isAuthenticated() && userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      allow update: if isAuthenticated() && userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      allow delete: if isAuthenticated() && userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Products collection
    match /products/{productId} {
      // In development, allow access when authenticated OR when no auth (for test tokens)
      allow get: if isAuthenticated() || request.auth == null;
      allow list: if isAuthenticated() || request.auth == null;
      allow create: if isAuthenticated() || request.auth == null;
      allow update: if false;
      allow delete: if isAuthenticated() && userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Batches collection
    match /batches/{batchId} {
      // Allow reading batches that belong to user's organization
      allow get: if isAuthenticated() && userDocExists() && resource.data.orgId != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == resource.data.orgId;
      // Allow querying batches (results filtered by get permission)
      allow list: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && userDocExists() && resource.data.orgId != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == resource.data.orgId;
      allow delete: if isAuthenticated() && userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Movements collection
    match /movements/{moveId} {
      // In development, allow access when authenticated OR when no auth (for test tokens)
      allow get: if isAuthenticated() || request.auth == null;
      allow list: if isAuthenticated() || request.auth == null;
      allow create: if isAuthenticated() || request.auth == null;
      allow update: if isAuthenticated() && userDocExists() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'warehouse' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      allow delete: if isAuthenticated() && userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Handovers collection (digital handover logs)
    match /handovers/{handoverId} {
      // In development, allow access when authenticated OR when no auth (for test tokens)
      allow get: if isAuthenticated() || request.auth == null;
      allow list: if isAuthenticated() || request.auth == null;
      allow create: if isAuthenticated() || request.auth == null; // Created via API route with permission checks
      allow update: if false; // Handovers are immutable
      allow delete: if false; // Handovers cannot be deleted
    }

    // QC Logs collection (quality control logs)
    match /qc_logs/{qcLogId} {
      // In development, allow access when authenticated OR when no auth (for test tokens)
      allow get: if isAuthenticated() || request.auth == null;
      allow list: if isAuthenticated() || request.auth == null;
      allow create: if isAuthenticated() || request.auth == null; // Created via API route with permission checks (warehouse/admin only)
      allow update: if false; // QC logs are immutable
      allow delete: if false; // QC logs cannot be deleted
    }

    // Verifications collection
    match /verifications/{verificationId} {
      // In development, allow access when authenticated OR when no auth (for test tokens)
      allow get: if isAuthenticated() || request.auth == null;
      allow list: if isAuthenticated() || request.auth == null;
      // Allow authenticated users to create verifications via API (authentication verified in API route)
      allow create: if isAuthenticated() || request.auth == null;
      allow update: if false;
      allow delete: if false;
    }

    // Transactions collection (append-only ledger)
    match /transactions/{transactionId} {
      // In development, allow access when authenticated OR when no auth (for test tokens)
      allow get: if isAuthenticated() || request.auth == null;
      allow list: if isAuthenticated() || request.auth == null;
      // Allow authenticated users to create transactions via API (authentication verified in API route)
      // Transactions are immutable once created
      allow create: if isAuthenticated() || request.auth == null;
      allow update: if false; // Transactions are immutable
      allow delete: if false; // Transactions cannot be deleted
    }

    // Suppliers collection
    match /suppliers/{supplierId} {
      allow get: if isAuthenticated();
      allow list: if isAuthenticated();
      allow create: if isAuthenticated() && userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      allow update: if isAuthenticated() && userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      allow delete: if isAuthenticated() && userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Reports collection
    match /reports/{reportId} {
      allow get: if isAuthenticated() && ((userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin') || (userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'auditor') || (resource.data.reporterId != null && request.auth.uid == resource.data.reporterId));
      allow list: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      allow delete: if isAuthenticated() && userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Alerts collection
    match /alerts/{alertId} {
      // Allow reading alerts that belong to user's organization
      allow get: if isAuthenticated() && userDocExists() && resource.data.orgId != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == resource.data.orgId;
      // Allow querying alerts (results filtered by get permission)
      allow list: if isAuthenticated();
      allow create: if false;
      allow update: if isAuthenticated() && userDocExists() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == resource.data.orgId);
      allow delete: if isAuthenticated() && userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Company registration requests collection
    match /companyRegistrationRequests/{requestId} {
      // Allow users to read their own requests or admins to read all
      // When reading, resource exists
      allow get: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
      
      // Allow users to list/query their own requests or admins to query all
      allow list: if isAuthenticated();
      
      // Allow authenticated users to create requests with their own userId
      // Use request.resource because document doesn't exist yet when creating
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Only admins can update requests (to approve/reject)
      allow update: if isAuthenticated() && userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // User invitations collection
    match /userInvitations/{invitationId} {
      // Allow users to read invitations that match their email OR admin to read all
      allow get: if isAuthenticated() && (
        resource.data.email == request.auth.token.email ||
        (userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
      
      // Allow querying by email (for linkUserToInvitation)
      // Users can query for invitations, but can only read documents matching their email
      // The query itself is allowed, but results are filtered by get permission
      allow list: if isAuthenticated();
      
      allow create: if isAuthenticated() && (
        // Allow creating invitation with user's own email (for self-registration scenarios)
        // OR admin can create any invitation
        request.resource.data.email == request.auth.token.email ||
        (userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
      // Allow users to update their own invitation (when accepting it) OR admin to update any
      allow update: if isAuthenticated() && (
        resource.data.email == request.auth.token.email ||
        (userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
      allow delete: if isAuthenticated() && userDocExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // MFA secrets (server-only)
    match /mfa_secrets/{userId} {
      allow read: if false;
      allow write: if false;
    }
  }
}
